pipeline {
    agent any

    environment {
        // Noms des images Docker
        TEST_IMAGE = 'arxive-tests'
        APP_IMAGE = 'arxiv-app'
        
        // Variables d'accès (Utilisent des identifiants stockés dans Jenkins)
        AWS_ACCESS_KEY_ID     = credentials('AWS_ACCESS_KEY_ID')
        AWS_SECRET_ACCESS_KEY = credentials('AWS_SECRET_ACCESS_KEY')
        
        // Configuration S3
        AWS_DEFAULT_REGION    = 'eu-west-3'
        S3_BUCKET_NAME        = 'bucketarxiv'
    }

    stages {

        stage('Build ETL Container') {
    steps {
        dir('.') { 
            // Utilise le Dockerfile dans 'jenkins/', qui doit être le Dockerfile Python
            sh "docker build -t ${APP_IMAGE} -f jenkins/Dockerfile ."
                }
            }
        }

        stage('Run Unit Tests') {
            steps {
                dir('.') {
                    // NOUVEAU : Exécution avec Pytest et ajout de S3_BUCKET
                    sh """
                    docker run --rm \\\\
                        --env AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID} \\\\
                        --env AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY} \\\\
                        --env AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION} \\\\
                        --env S3_BUCKET=${S3_BUCKET_NAME} \\\\
                        ${TEST_IMAGE} pytest jenkins/tests/test_fetch_arxiv.py --junitxml=jenkins/tests/junit-report.xml
                    """
                }
            }
            post {
                always {
                    // Publie les résultats des tests unitaires
                    junit 'jenkins/tests/junit-report.xml'
                }
            }
        }

        stage('Build ETL Container') {
            steps {
                dir('jenkins') {
                    // Suppose que le Dockerfile de l'application (APP_IMAGE) est dans le dossier 'jenkins'
                    sh "docker build -t ${APP_IMAGE} ."
                }
            }
        }

        stage('Run ETL and Upload to S3') {
            steps {
                dir('.') {
                    echo "Starting ETL Process using ${APP_IMAGE}..."

                    // NOUVEAU : Correction du chemin d'exécution dans le conteneur
                    sh """
                    docker run --rm \\\\
                        --env AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID} \\\\
                        --env AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY} \\\\
                        --env AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION} \\\\
                        --env S3_BUCKET=${S3_BUCKET_NAME} \\\\
                        ${APP_IMAGE} python /app/jenkins/tests/fetch_arxiv_unitaire.py
                    """
                }
            }
        }
    }

    post {
        success {
            echo '✅ Pipeline completed successfully!'
        }
        failure {
            echo '❌ Pipeline failed.'
        }
    }
}